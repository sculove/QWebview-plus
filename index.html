<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<script src="https://code.jquery.com/jquery-2.2.2.min.js" integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=" crossorigin="anonymous"></script>
<script>
Date.prototype.yyyymmdd = function()
{
    var yyyy = this.getFullYear().toString();
    var mm = (this.getMonth() + 1).toString();
    var dd = this.getDate().toString();
    return yyyy + (mm[1] ? mm : '0'+mm[0]) + (dd[1] ? dd : '0'+dd[0]);
}
</script>
</head>
<body>
<div>
    <label>종목코드</label><input type="text" id="stockcode" value="003000" />
    <button id="search">종목 검색</button>
    <button id="chart">차트 데이터 검색</button>
</div>
<script>
var $code = $("#stockcode");

document.addEventListener("receiveMsg.kiwoom", function(e) {
    var data = e.detail;
    console.log({
        "scrNo" : data.scrNo,
        "rQName" : data.rQName,
        "trCode": data.trCode,
        "msg" : data.msg
    });
});

document.addEventListener("receiveTrData.kiwoom:opt10081", async function({detail}) {
    const {trCode, rQName, recordName, prevNext, data} = detail;
    if(prevNext == "2") {
        console.log("다음건 요청", data);        
        kiwoom.commRqData("주식일봉차트조회요청", "opt10081", prevNext, "0002", {
            "종목코드": $code.val(),
            "기준일자": (new Date()).yyyymmdd(),
            "수정주가구분": 0
        });
    }
});

document.addEventListener("receiveRealData.kiwoom", function({detail}) {
    const {code, realType, realData} = detail;
    console.info("실시간데이터 이벤트 처리", {
        code,
        realType,
        realData
    });
});

$("#search").click(async function(e) {
    var status = await kiwoom.getConnectState();
    if(status == 0) {
        alert("로그인필요")
    } else if(status == 1) {
        search();
    }
});

$("#chart").click(async function(e) {
    var status = await kiwoom.getConnectState();
    if(status == 0) {
        alert("로그인필요")
    } else if(status == 1) {
        chart();
    }
});

// 종목 TR 검색
function search() {
    // rQName과 화면번호는 사용자가 지정하여 구분하는 값
    kiwoom.commRqData("주식기본정보요청", "opt10001", 0, "0001", {
        "종목코드": $code.val()
    });
}

function chart() {
    // rQName과 화면번호는 사용자가 지정하여 구분하는 값
    kiwoom.commRqData("주식일봉차트조회요청", "opt10081", 0, "0002", {
        "종목코드": $code.val(),
        "기준일자": (new Date()).yyyymmdd(),
        "수정주가구분": 0
    });
}
</script>

</body>
</html>